<!DOCTYPE html>
<html lang="en">
<head>
  <title>Health chat service - jawrainey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Placed here rather than footer as we need to display the initial message -->
  <script src="{{ url_for('static', filename='js/jquery.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/socket.io.min.js', _external=True) }}"></script>
  <link href="{{ url_for('static', filename='css/bootstrap.min.css', _external=True) }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/custom.css', _external=True) }}" rel="stylesheet">
  <script>
  $(document).ready(function() {
    // explicit package upon connection to prevent global namespace use.
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
    // emits user input data to server.
    $('form#emit').submit(function(event) {
        socket.emit('user', {data: $('#emit_data').val()});
        return false;
    });
    // response sent from server; user message sent to output on screen.
    socket.on('response', function(msg) {
      // Add a right column that includes feedback bar in service response.
      // TODO: remove duplicated code. Possibly build this in Python end?
      // Would prevent evil-doers, and could remove duplicated code.
      left_arrow = "<button type=\"button\" class=\"btn btn-default left-arrow\">" +
                     "<span class=\"glyphicon glyphicon-arrow-left\" aria-hidden=\"true\"></span>" +
                   "</button>";

      right_arrow = "<button type=\"button\" class=\"btn btn-default right-arrow\">" +
                     "<span class=\"glyphicon glyphicon-arrow-right\" aria-hidden=\"true\"></span>" +
                    "</button>";

      feedback = (msg.type.indexOf("service") > -1) ? "<div class=\"feedback\">" + left_arrow + right_arrow + "</div>" : "";

      // required to easily identify 'message-wrap' that contains user messages.
      // TODO: remove message-wrap ID as there are multiple message-wraps, so
      // semantically, it should be a class. Instead, use these classes in CSS.
      named_id = (msg.type.indexOf("service") > -1) ? "service_message" : "client_message";

      output = "<div id=\"message-wrap\" class=" + named_id + ">" +
                  "<div class=\"message\">" +
                    "<p>" + msg.data + "</p>" +
                  "</div>" +
                  feedback +
                "</div>";

      $("#messages").prepend(output);
    });

    // When vote cast send data to server to enable response (update) or question.
    // NOTE: this will only change IFF a down-vote has been cast.
    // TODO: What happens when up/down for initial question, or RS?
    $(document).on('click', 'button', function (e) {
        // Making this available to update it below on response -- sneaky & probably dangerous.
        question_div = $(this).closest('#message-wrap').find('.message');
        // Send relevant data (associated OEQ, rating, previous msg for analysis) to server.
        socket.emit('vote', {
          question: question_div.text(),
          rating: $(this).attr('class').indexOf("left") > -1 ?  "down": "up",
          prev_user_msg : $(this).closest('#messages').find('.client_message:first').text()
        });
        return false;
    });

    // response sent from server to client once a vote has been cast.
    socket.on('vote response', function(msg) {
      // TODO: make it obvious text has changed.
      question_div.text(msg.data);
    });

    // Allow user to press enter to submit message.
    // TODO: currently using blur to deselect form.
    // Need a way to reset it without leaving newline in textarea.
    // blur currently works, but then user has to reselect form -- bad UX.
    $('form#emit').keypress(function(e) {
      if (e.which == 13) {
        $('#emit').submit();
        $('textarea').blur().val('');
      }
    });

  });
  </script>
</head>
<body>
  <div class="container">
    <h1>Jamie's health chat</h1>
      <form id="emit" class="form" method="POST" action='#'>
        <textarea id="emit_data" class="form-control" placeholder="Type your response here and press enter to submit your message."></textarea>
      </form>
  </div>
  <footer class="footer">
    <div class="container">
      <div id="messages"></div>
    </div>
  </footer>
</body>
</html>
