<!DOCTYPE html>
<html lang="en">
<head>
  <title>Health chat service - jawrainey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Placed here rather than footer as we need to display the initial message -->
  <script src="{{ url_for('static', filename='js/jquery.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/socket.io.min.js', _external=True) }}"></script>
  <link href="{{ url_for('static', filename='css/bootstrap.min.css', _external=True) }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/custom.css', _external=True) }}" rel="stylesheet">
  <script>
  $(document).ready(function() {
    // explicit package upon connection to prevent global namespace use.
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
    // emits user input data to server.
    $('form#emit').submit(function(event) {
        socket.emit('user', {data: $('#emit_data').val()});
        return false;
    });
    // response sent from server; user message sent to output on screen.
    socket.on('response', function(msg) {
      // Add a right column that includes feedback bar in service response.
      // TODO: remove duplicated code. Possibly build this in Python end?
      // Would prevent evil-doers, and could remove duplicated code.
      left_arrow = "<button type=\"button\" class=\"btn btn-default left-arrow\">" +
                     "<span class=\"glyphicon glyphicon-arrow-left\" aria-hidden=\"true\"></span>" +
                   "</button>";

      right_arrow = "<button type=\"button\" class=\"btn btn-default right-arrow\">" +
                     "<span class=\"glyphicon glyphicon-arrow-right\" aria-hidden=\"true\"></span>" +
                    "</button>";

      feedback = (msg.type.indexOf("service") > -1) ? "<div class=\"feedback\">" + left_arrow + right_arrow + "</div>" : "";

      output = "<div id=\"message-wrap\">" +
                  "<div class=\"message\">" +
                    "<p>" + msg.data + "</p>" +
                  "</div>" +
                  feedback +
                "</div>";

      $("#messages").prepend(output);
    });

    // Allow user to press enter to submit message.
    // TODO: currently using blur to deselect form.
    // Need a way to reset it without leaving newline in textarea.
    // blur currently works, but then user has to reselect form -- bad UX.
    $('form#emit').keypress(function(e) {
      if (e.which == 13) {
        $('#emit').submit();
        $('textarea').blur().val('');
      }
    });

  });
  </script>
</head>
<body>
  <div class="container">
    <h1>Jamie's health chat</h1>
      <form id="emit" class="form" method="POST" action='#'>
        <textarea id="emit_data" class="form-control" placeholder="Type your response here and press enter to submit your message."></textarea>
      </form>
  </div>
  <footer class="footer">
    <div class="container">
      <div id="messages"></div>
    </div>
  </footer>
</body>
</html>
