<!DOCTYPE html>
<html lang="en">
<head>
  <title>Health chat service - jawrainey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Placed here rather than footer as we need to display the initial message -->
  <script src="{{ url_for('static', filename='js/jquery.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap.min.js', _external=True) }}"></script>
  <script src="{{ url_for('static', filename='js/socket.io.min.js', _external=True) }}"></script>
  <link href="{{ url_for('static', filename='css/bootstrap.min.css', _external=True) }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/custom.css', _external=True) }}" rel="stylesheet">
  <script>
  $(document).ready(function() {
    // explicit package upon connection to prevent global namespace use.
    var socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
    // emits user input data to server.
    $('form#emit').submit(function(event) {
        socket.emit('user', {data: $('#emit_data').val()});
        return false;
    });
    // response sent from server; user message sent to output on screen.
    socket.on('response', function(msg) {
      // Add a right column that includes feedback bar in service response.
      // This will be simplified later similar to output below.
      feedback = (msg.data.indexOf("Service:") > -1) ? "<div class=\"feedback\"><div class=\"progress\"> <div class=\"progress-bar\" role=\"progressbar\" aria-valuenow=\"60\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 60%;\"></div> </div></div>" : "";

      output = "<div id=\"message-wrap\">" +
                  "<div class=\"message\">" +
                    "<p>" + msg.data + "</p>" +
                  "</div>" +
                  feedback +
                "</div>";

      $("#messages").append(output);
      $("#messages").scrollTop($("#messages")[0].scrollHeight); // latest message first
    });

    // Allow user to press enter to submit message.
    // TODO: currently using blur to deselect form.
    // Need a way to reset it without leaving newline in textarea.
    // blur currently works, but then user has to reselect form -- bad UX.
    $('.form-control').keypress(function(e) {
      if (e.which == 13) {
        $('.form').submit();
        $('textarea').blur().val('');
      }
    });

  });
  </script>
</head>
<body>
  <div class="container">
    <h1>Jamie's health chat</h1>
    <div id="messages"></div>
  </div>
  <footer class="footer">
    <div class="container">
      <form id="emit" class="form" method="POST" action='#'>
        <textarea id="emit_data" class="form-control" placeholder="Type your response here and press enter to submit your message."></textarea>
      </form>
    </div>
  </footer>
</body>
</html>
